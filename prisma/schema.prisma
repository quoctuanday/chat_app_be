generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --------------------- USER ---------------------
model User {
  user_id    String     @id @default(uuid())
  username   String     @unique
  email      String?    @unique
  password   String
  avatar_url String? @db.Text
  status     UserStatus @default(offline)
  last_active DateTime?
  created_at DateTime   @default(now())

  // Quan há»‡
  conversationsCreated Conversation[]       @relation("CreatedConversations")
  conversationMembers  ConversationMember[]
  messages             Message[]
  messageStatuses      MessageStatus[]
  friendships          Friendship[] @relation("UserFriendships")
  friendsWith          Friendship[] @relation("UserFriendsWith")
  notifications        Notification[]
  typingStatuses       TypingStatus[]
}

enum UserStatus {
  online
  offline
  busy
}

// --------------------- CONVERSATION ---------------------
model Conversation {
  conversation_id String           @id @default(uuid())
  type            ConversationType
  name            String?
  avatar_url      String? 
  created_at      DateTime         @default(now())
  updated_at      DateTime         @default(now()) @updatedAt
  is_archived     Boolean          @default(false)
  created_by_id   String?
  created_by      User? @relation("CreatedConversations", fields: [created_by_id], references: [user_id])

  members  ConversationMember[]
  messages Message[]
  typingStatuses TypingStatus[]
}

enum ConversationType {
  private
  group
}

// --------------------- CONVERSATION MEMBER ---------------------
model ConversationMember {
  conversation    Conversation @relation(fields: [conversation_id], references: [conversation_id])
  conversation_id String
  user            User         @relation(fields: [user_id], references: [user_id])
  user_id         String
  role            MemberRole   @default(member)
  joined_at       DateTime     @default(now())
  last_read_message_id String?
  is_muted        Boolean      @default(false)

  @@id([conversation_id, user_id])
}

enum MemberRole {
  member
  admin
}

// --------------------- MESSAGE ---------------------
model Message {
  message_id      String       @id @default(uuid())
  conversation    Conversation @relation(fields: [conversation_id], references: [conversation_id])
  conversation_id String
  sender          User         @relation(fields: [sender_id], references: [user_id])
  sender_id       String
  content         String?
  message_type    MessageType  @default(text)
  created_at      DateTime     @default(now())
  is_deleted      Boolean      @default(false)
  reactions       Json?

  reply_to        Message?     @relation("MessageReplies", fields: [reply_to_id], references: [message_id])
  reply_to_id     String?
  replies         Message[]    @relation("MessageReplies")

  statuses    MessageStatus[]
  attachments Attachment[]
}

enum MessageType {
  text
  image
  file
  system
}

// --------------------- MESSAGE STATUS ---------------------
model MessageStatus {
  message    Message  @relation(fields: [message_id], references: [message_id])
  message_id String
  user       User     @relation(fields: [user_id], references: [user_id])
  user_id    String
  status     Status   @default(sent)
  updated_at DateTime @default(now()) @updatedAt

  @@id([message_id, user_id])
}

enum Status {
  sent
  delivered
  read
}

// --------------------- FRIENDSHIP ---------------------
model Friendship {
  user       User         @relation("UserFriendships", fields: [user_id], references: [user_id])
  user_id    String
  friend     User         @relation("UserFriendsWith", fields: [friend_id], references: [user_id])
  friend_id  String
  status     FriendStatus @default(pending)
  created_at DateTime     @default(now())
  updated_at DateTime     @default(now()) @updatedAt
  blocked_by_user_id String?

  @@id([user_id, friend_id])
}

enum FriendStatus {
  pending
  accepted
  blocked
}

// --------------------- ATTACHMENT ---------------------
model Attachment {
  attachment_id String    @id @default(uuid())
  message       Message   @relation(fields: [message_id], references: [message_id])
  message_id    String
  file_url      String
  file_type     FileType  @default(file)
  file_size     Int?
  thumbnail_url String?
  uploaded_at   DateTime  @default(now())
}

enum FileType {
  image
  video
  file
  audio
}

// --------------------- TYPING STATUS ---------------------
model TypingStatus {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversation_id], references: [conversation_id])
  conversation_id String
  user           User         @relation(fields: [user_id], references: [user_id])
  user_id        String
  is_typing      Boolean      @default(false)
  updated_at     DateTime     @default(now()) @updatedAt
}

// --------------------- NOTIFICATION ---------------------
model Notification {
  notification_id String   @id @default(uuid())
  user            User     @relation(fields: [user_id], references: [user_id])
  user_id         String
  type            String
  payload         Json
  is_read         Boolean  @default(false)
  created_at      DateTime @default(now())
}
